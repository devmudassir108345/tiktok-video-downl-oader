<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Video Downloader</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fab fa-tiktok"></i>
                <h1>TikTok Downloader</h1>
            </div>
            <p class="subtitle">Download TikTok videos in high quality</p>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- URL Input Section -->
            <section class="input-section">
                <div class="input-container">
                    <input type="url" id="videoUrl" placeholder="Paste TikTok video URL here..." class="url-input">
                    <button id="extractBtn" class="extract-btn">
                        <i class="fas fa-search"></i>
                        <span>Extract Info</span>
                    </button>
                </div>
                <div class="url-examples">
                    <p>Supported formats:</p>
                    <span>tiktok.com/@username/video/...</span>
                    <span>vm.tiktok.com/...</span>
                    <span>vt.tiktok.com/...</span>
                </div>
            </section>

            <!-- Loading Section -->
<section id="loadingSection" class="loading-section hidden">
    <div class="loading-spinner">
        <div class="progress-container">
            <div class="progress-info">
                <i class="fas fa-search"></i>
                <span>Extracting video information...</span>
                <span id="extractProgress" class="progress-percentage">0%</span>
            </div>
            <div class="progress-bar">
                <div id="extractProgressFill" class="progress-fill"></div>
            </div>
        </div>
    </div>
</section>

            <!-- Video Info Section -->
            <section id="videoInfoSection" class="video-info-section hidden">
                <div class="video-card">
                    <div class="video-thumbnail">
                        <img id="videoThumbnail" src="/placeholder.svg" alt="Video Thumbnail">
                        <div class="play-overlay">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                    <div class="video-details">
                        <h3 id="videoTitle">Video Title</h3>
                        <div class="video-meta">
                            <span id="videoUploader"><i class="fas fa-user"></i> Unknown</span>
                            <span id="videoDuration"><i class="fas fa-clock"></i> 0:00</span>
                            <span id="videoViews"><i class="fas fa-eye"></i> 0 views</span>
                        </div>
                    </div>
                </div>

                <!-- Format Selection -->
                <div class="format-section">
                    <h4>Choose Quality & Format:</h4>
                    <div id="formatList" class="format-list">
                        <!-- Formats will be populated here -->
                    </div>
                </div>

                <!-- Download Button -->
                <button id="downloadBtn" class="download-btn disabled">
                    <i class="fas fa-download"></i>
                    <span>Select a format to download</span>
                </button>
            </section>

            <!-- Download Progress Section -->
<section id="downloadSection" class="download-section hidden">
    <div class="download-progress">
        <div class="progress-container">
            <div class="progress-info">
                <i class="fas fa-download"></i>
                <span>Downloading video...</span>
                <span id="downloadProgress" class="progress-percentage">0%</span>
            </div>
            <div class="progress-bar">
                <div id="downloadProgressFill" class="progress-fill"></div>
            </div>
            <div class="download-details">
                <span id="downloadSpeed">Speed: Calculating...</span>
                <span id="downloadSize">Size: Unknown</span>
                <span id="downloadETA">ETA: Calculating...</span>
            </div>
        </div>
    </div>
</section>

            <!-- Download Complete Section -->
            <section id="downloadCompleteSection" class="download-complete-section hidden">
                <div class="success-card">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>Download Complete!</h3>
                    <p>Your video has been successfully downloaded.</p>
                    <div class="download-actions">
                        <a id="downloadLink" href="#" class="download-link-btn">
                            <i class="fas fa-download"></i>
                            <span>Download File</span>
                        </a>
                        <button id="downloadAnotherBtn" class="secondary-btn">
                            <i class="fas fa-plus"></i>
                            <span>Download Another</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Error Section -->
            <section id="errorSection" class="error-section hidden">
                <div class="error-card">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3>Error Occurred</h3>
                    <p id="errorMessage">Something went wrong. Please try again.</p>
                    <button id="retryBtn" class="retry-btn">
                        <i class="fas fa-redo"></i>
                        <span>Try Again</span>
                    </button>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2024 TikTok Downloader. Built with Flask & yt-dlp</p>
            <div class="footer-links">
                <a href="#"><i class="fas fa-info-circle"></i> About</a>
                <a href="#"><i class="fas fa-shield-alt"></i> Privacy</a>
                <a href="#"><i class="fas fa-envelope"></i> Contact</a>
            </div>
        </footer>
    </div>

    <script>
        // Global variables
        let currentSessionId = null;
        let selectedFormat = null;

        // DOM elements
        const videoUrlInput = document.getElementById('videoUrl');
        const extractBtn = document.getElementById('extractBtn');
        const loadingSection = document.getElementById('loadingSection');
        const videoInfoSection = document.getElementById('videoInfoSection');
        const downloadSection = document.getElementById('downloadSection');
        const downloadCompleteSection = document.getElementById('downloadCompleteSection');
        const errorSection = document.getElementById('errorSection');
        const downloadBtn = document.getElementById('downloadBtn');
        const formatList = document.getElementById('formatList');
        const downloadLink = document.getElementById('downloadLink');
        const downloadAnotherBtn = document.getElementById('downloadAnotherBtn');
        const retryBtn = document.getElementById('retryBtn');
        const errorMessage = document.getElementById('errorMessage');

        // Event listeners
        extractBtn.addEventListener('click', extractVideoInfo);
        downloadBtn.addEventListener('click', downloadVideo);
        downloadAnotherBtn.addEventListener('click', resetForm);
        retryBtn.addEventListener('click', resetForm);
        videoUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') extractVideoInfo();
        });

        // Show section function
        function showSection(section) {
            const sections = [loadingSection, videoInfoSection, downloadSection, downloadCompleteSection, errorSection];
            sections.forEach(s => s.classList.add('hidden'));
            section.classList.remove('hidden');
        }

        // Show error function
        function showError(message) {
            errorMessage.textContent = message;
            showSection(errorSection);
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return 'Unknown size';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Format duration
        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Format number
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // Extract video info
        async function extractVideoInfo() {
            const url = videoUrlInput.value.trim();
            
            if (!url) {
                showError('Please enter a TikTok video URL');
                return;
            }

            // Validate TikTok URL
            const tiktokRegex = /^https?:\/\/(www\.)?(tiktok\.com|vm\.tiktok\.com|vt\.tiktok\.com|m\.tiktok\.com)/;
            if (!tiktokRegex.test(url)) {
                showError('Please enter a valid TikTok URL');
                return;
            }

            showSection(loadingSection);
            animateExtractProgress();
            extractBtn.disabled = true;

            try {
                const response = await fetch('/extract', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });

                const data = await response.json();

                if (data.success) {
                    currentSessionId = data.session_id;
                    displayVideoInfo(data.video_info);
                } else {
                    showError(data.error || 'Failed to extract video information');
                }
            } catch (error) {
                showError('Network error. Please check your connection and try again.');
            } finally {
                extractBtn.disabled = false;
            }
        }

        // Display video info
        function displayVideoInfo(videoInfo) {
            // Update video details
            document.getElementById('videoThumbnail').src = videoInfo.thumbnail || '/placeholder.svg?height=300&width=400';
            document.getElementById('videoTitle').textContent = videoInfo.title;
            document.getElementById('videoUploader').innerHTML = `<i class="fas fa-user"></i> ${videoInfo.uploader}`;
            document.getElementById('videoDuration').innerHTML = `<i class="fas fa-clock"></i> ${formatDuration(videoInfo.duration)}`;
            document.getElementById('videoViews').innerHTML = `<i class="fas fa-eye"></i> ${formatNumber(videoInfo.view_count)} views`;

            // Populate format list
            formatList.innerHTML = '';
            videoInfo.formats.forEach(format => {
                const formatItem = document.createElement('div');
                formatItem.className = 'format-item';
                formatItem.innerHTML = `
                    <div class="format-info">
                        <span class="format-quality">${format.quality}</span>
                        <span class="format-type">${format.ext.toUpperCase()}</span>
                        ${format.filesize ? `<span class="format-size">${formatFileSize(format.filesize)}</span>` : ''}
                    </div>
                    <div class="format-icon">
                        <i class="fas ${format.quality === 'Audio Only' ? 'fa-music' : 'fa-video'}"></i>
                    </div>
                `;
                
                formatItem.addEventListener('click', () => selectFormat(format, formatItem));
                formatList.appendChild(formatItem);
            });

            showSection(videoInfoSection);
        }

        // Select format
        function selectFormat(format, element) {
            // Remove previous selection
            document.querySelectorAll('.format-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Add selection to clicked item
            element.classList.add('selected');
            selectedFormat = format;

            // Enable download button
            downloadBtn.classList.remove('disabled');
            downloadBtn.innerHTML = `
                <i class="fas fa-download"></i>
                <span>Download ${format.quality} (${format.ext.toUpperCase()})</span>
            `;
        }

        // Download video
        async function downloadVideo() {
            if (!selectedFormat || !currentSessionId) {
                showError('Please select a format first');
                return;
            }

            showSection(downloadSection);
            animateDownloadProgress();

            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        format_id: selectedFormat.format_id
                    })
                });

                const data = await response.json();

                if (data.success) {
                    downloadLink.href = data.download_url;
                    downloadLink.download = data.filename;
                    showSection(downloadCompleteSection);
                } else {
                    showError(data.error || 'Download failed');
                }
            } catch (error) {
                showError('Network error during download. Please try again.');
            }
        }

        // Reset form
        function resetForm() {
            videoUrlInput.value = '';
            currentSessionId = null;
            selectedFormat = null;
            downloadBtn.classList.add('disabled');
            downloadBtn.innerHTML = `
                <i class="fas fa-download"></i>
                <span>Select a format to download</span>
            `;
            
            const sections = [loadingSection, videoInfoSection, downloadSection, downloadCompleteSection, errorSection];
            sections.forEach(s => s.classList.add('hidden'));
        }

        // Auto-focus on URL input
        videoUrlInput.focus();

        // Progress animation functions
function animateExtractProgress() {
    const progressElement = document.getElementById('extractProgress');
    const progressFill = document.getElementById('extractProgressFill');
    let progress = 0;
    const duration = 2500; // 2.5 seconds
    const startTime = Date.now();
    
    const interval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const progressPercent = Math.min((elapsed / duration) * 100, 100);
        
        // Simulate realistic extraction progress
        if (progressPercent < 30) {
            progress = progressPercent * 0.5; // Slow start
        } else if (progressPercent < 70) {
            progress = 15 + (progressPercent - 30) * 1.5; // Fast middle
        } else {
            progress = 75 + (progressPercent - 70) * 0.8; // Slow finish
        }
        
        progress = Math.min(progress, 100);
        progressElement.textContent = Math.floor(progress) + '%';
        progressFill.style.width = progress + '%';
        
        if (progress >= 100) {
            clearInterval(interval);
        }
    }, 50);
}

function animateDownloadProgress() {
    const progressElement = document.getElementById('downloadProgress');
    const progressFill = document.getElementById('downloadProgressFill');
    const speedElement = document.getElementById('downloadSpeed');
    const sizeElement = document.getElementById('downloadSize');
    const etaElement = document.getElementById('downloadETA');
    
    let progress = 0;
    const duration = 4000; // 4 seconds
    const startTime = Date.now();
    const totalSize = Math.random() * 50 + 10; // Random size between 10-60 MB
    
    sizeElement.textContent = `Size: ${totalSize.toFixed(1)} MB`;
    
    const interval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const progressPercent = Math.min((elapsed / duration) * 100, 100);
        
        // Simulate realistic download progress with variable speed
        if (progressPercent < 20) {
            progress = progressPercent * 0.3; // Very slow start
        } else if (progressPercent < 40) {
            progress = 6 + (progressPercent - 20) * 2; // Speed up
        } else if (progressPercent < 80) {
            progress = 46 + (progressPercent - 40) * 1.2; // Steady speed
        } else {
            progress = 94 + (progressPercent - 80) * 0.3; // Slow finish
        }
        
        progress = Math.min(progress, 100);
        const currentSize = (progress / 100) * totalSize;
        const speed = progress < 100 ? (Math.random() * 3 + 1).toFixed(1) : '0.0';
        const remainingSize = totalSize - currentSize;
        const eta = progress < 100 ? Math.ceil(remainingSize / parseFloat(speed)) : 0;
        
        progressElement.textContent = Math.floor(progress) + '%';
        progressFill.style.width = progress + '%';
        speedElement.textContent = `Speed: ${speed} MB/s`;
        
        if (progress < 100) {
            etaElement.textContent = `ETA: ${eta}s`;
        } else {
            etaElement.textContent = 'ETA: Complete';
            speedElement.textContent = 'Speed: Complete';
        }
        
        if (progress >= 100) {
            clearInterval(interval);
        }
    }, 100);
}
    </script>
</body>
</html>
